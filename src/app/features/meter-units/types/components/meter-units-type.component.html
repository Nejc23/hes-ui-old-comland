<app-auto-refresh
      (timerExpired)="refresh()"
      [elapseTime]="refreshInterval"
      [hidden]="true">
</app-auto-refresh>

<div class="row">
  <div class="col-2 filter-shadow-container" *ngIf="!hideFilter">
    <div class="filter-shadow">
      <app-meter-unit-filter (filterChange)="filterChanged()" (toggleFilter)="toggleFilter()"></app-meter-unit-filter>
    </div>
  </div>

  <div class="filter-button" [ngClass]="{'col-10': !hideFilter, 'col-12': hideFilter}">

<!-- row total items, selected filter name -->
<div *ngIf="!noData">

  <div class="mb-2">
    <div class="grid-actions">
      <app-action-form
        [gridColumns]="columns"
        [isFilterOpened]="!hideFilter"
        [filtersInfo]="filtersInfo"
        (searchChange)="searchData($event)"
        (refresh)="refreshGrid()"
        (toggleFilter)="toggleFilter()"
        (toggleWildcards)="toggleWildcards($event)"
        >

        <div *ngIf="!selectedAtLeastOneRowOnGrid" class="pr-3">
          <button class="btn btn-primary mr-1" appHideIfPermissionUnauthorized [permission]="permissionMuManage" href="javascript:void(0)" (click)="onAdd()">{{ 'BUTTON.ADD' | translate }}</button>
        </div>

        <div *ngIf="selectedAtLeastOneRowOnGrid" class="pr-3">
          <button  class="btn btn-primary mr-1" appHideIfPermissionUnauthorized [permission]="permissionMuManage" [functionality]="formFunctionality" href="javascript:void(0)" (click)="onDelete()">{{ 'BUTTON.DELETE' | translate }}</button>
          <div dropdown class="btn-group" appHideIfAllPermissionsUnauthorized [permissions]="[
            permissionManageJobs,
            permissionAssignTemplates,
            permissionFwUpgrade,
            permissionFwUpgrade,
            permissionDisconnectorConnect,
            permissionDisconnectorDisconnect,
            permissionDisconnectorGetState,
            permissionDisconnectorSetMode,
            permissionCiiActivate,
            permissionCiiDeactivate,
            permissionCiiState,
            permissionRelaysConnect,
            permissionRelaysDisconnect,
            permissionRelaysState,
            permissionRelaysSetMode
          ]">
            <button dropdownToggle class="btn btn-primary dropdown-toggle" type="button" id="operationsDropDown" data-toggle="dropdown"><span>{{ 'OPERATION.OPERATIONS' | translate }}</span></button>
            <div *dropdownMenu (click)="$event.stopPropagation();" class="dropdown-menu" style="min-width: 13rem">
              <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionManageJobs">
                <div class="dropdown-submenu">
                  <a dropdownToggle class="dropdown-toggle disabled" href="javascript:void(0)" data-toggle="dropdown"><span>{{ 'COMMON.JOBS' | translate }}</span></a>
                  <div class="dropdown-menu">
                    <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionManageJobs" (click)="onScheduleReadJobs()">
                      <a href="javascript:void(0)"><span>{{ 'PLC-METER.CREATE-NEW' | translate }}</span></a>
                    </div>
                    <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionManageJobs" (click)="onJobsAssignExisting()">
                      <a href="javascript:void(0)"><span>{{ 'PLC-METER.ASSIGN-EXISTING' | translate }}</span></a>
                    </div>
                  </div>
                </div>
              </div>
              <div appHideIfPermissionUnauthorized [permission]="permissionAssignTemplates">
                <a href="javascript:void(0)" class="dropdown-item custom-hover-display"
                  (click)="onJobsTemplates()"><span>{{ 'PLC-METER.TEMPLATES' | translate }}</span></a>
              </div>

              <div class="dropdown-divider" appHideDividerIfPermissionsUnauthorized [permissionsAbove]="[permissionManageJobs, permissionAssignTemplates]" [permissionsBelow]="[permissionFwUpgrade]"></div>

              <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionFwUpgrade">
                <div class="dropdown-submenu">
                  <a dropdownToggle class="dropdown-toggle disabled" href="javascript:void(0)" data-toggle="dropdown"><span>{{ 'PLC-METER.FW-UPGRADE-TITLE' | translate }}</span></a>
                  <div class="dropdown-menu">
                    <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionFwUpgrade" (click)="onUpgrade()">
                      <a href="javascript:void(0)"><span>{{ 'PLC-METER.UPLOAD-IMAGE' | translate }}</span></a>
                    </div>
                    <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionFwUpgrade" (click)="onActivateUpgrade()">
                    <a href="javascript:void(0)"><span>{{ 'PLC-METER.ACTIVATE-IMAGE' | translate }}</span></a>
                    </div>
                  </div>
                </div>
              </div>
              <div class="dropdown-divider" appHideDividerIfPermissionsUnauthorized
                [permissionsAbove]="[permissionFwUpgrade]"
                [permissionsBelow]="[permissionDisconnectorConnect,
                                    permissionDisconnectorDisconnect,
                                    permissionDisconnectorGetState,
                                    permissionDisconnectorSetMode,
                                    permissionCiiActivate,
                                    permissionCiiDeactivate,
                                    permissionCiiState,
                                    permissionRelaysConnect,
                                    permissionRelaysDisconnect,
                                    permissionRelaysState,
                                    permissionRelaysSetMode]"></div>
              <div class="dropdown-item" appHideIfAllPermissionsUnauthorized [permissions]="[permissionDisconnectorConnect, permissionDisconnectorDisconnect, permissionDisconnectorGetState, permissionDisconnectorSetMode]">
                <div class="dropdown-submenu">
                  <a dropdownToggle class="dropdown-toggle disabled" href="javascript:void(0)" data-toggle="dropdown"><span>{{ 'PLC-METER.BREAKER.BREAKER' | translate }}</span></a>
                <div class="dropdown-menu">
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionDisconnectorConnect" (click)="onConnect()">
                    <a href="javascript:void(0)"><span>{{ 'COMMON.CONNECT' | translate }}</span></a>
                  </div>
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionDisconnectorDisconnect" (click)="onDisconnect()">
                    <a href="javascript:void(0)"><span>{{ 'COMMON.DISCONNECT' | translate }}</span></a>
                  </div>
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionDisconnectorGetState" (click)="onDisconnectorStatus()">
                    <a href="javascript:void(0)"><span>{{ 'COMMON.STATE' | translate }}</span></a>
                  </div>
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionDisconnectorSetMode" (click)="onDisconnectorMode()">
                    <a href="javascript:void(0)"><span>{{ 'COMMON.MODE' | translate }}</span></a>
                  </div>
                </div>
              </div>
             </div>
             <div class="dropdown-item" appHideIfAllPermissionsUnauthorized [permissions]="[permissionCiiActivate, permissionCiiDeactivate, permissionCiiState]">
             <div class="dropdown-submenu">
                <a dropdownToggle class="dropdown-toggle disabled" href="javascript:void(0)" data-toggle="dropdown"><span>{{ 'COMMON.CII' | translate }}</span></a>
                <div class="dropdown-menu">
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionCiiActivate" (click)="onCiiActivate()">
                    <a href="javascript:void(0)"><span>{{ 'COMMON.ACTIVATE' | translate }}</span></a>
                  </div>
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionCiiDeactivate" (click)="onCiiDeactivate()">
                    <a href="javascript:void(0)"><span>{{ 'COMMON.DEACTIVATE' | translate }}</span></a>
                  </div>
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionCiiState" (click)="onCiiState()">
                    <a  href="javascript:void(0)"><span>{{ 'COMMON.STATE' | translate }}</span></a>
                  </div>
                </div>
              </div>
              </div>
              <div class="dropdown-item" appHideIfAllPermissionsUnauthorized [permissions]="[permissionRelaysConnect, permissionRelaysDisconnect, permissionRelaysState, permissionRelaysSetMode]">
                <div class="dropdown-submenu">
                  <a dropdownToggle class="dropdown-toggle disabled" href="javascript:void(0)" data-toggle="dropdown"><span>{{ 'COMMON.RELAYS' | translate }}</span></a>
                <div class="dropdown-menu">
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionRelaysConnect" (click)="onRelaysConnect()">
                    <a href="javascript:void(0)"><span>{{ 'COMMON.CONNECT' | translate }}</span></a>
                  </div>
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionRelaysDisconnect" (click)="onRelaysDisconnect()" >
                    <a href="javascript:void(0)"><span>{{ 'COMMON.DISCONNECT' | translate }}</span></a>
                  </div>
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionRelaysState" (click)="onRelaysState()">
                    <a href="javascript:void(0)"><span>{{ 'COMMON.STATE' | translate }}</span></a>
                  </div>
                  <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionRelaysSetMode" (click)="onRelaysSetMode()">
                    <a href="javascript:void(0)" ><span>{{ 'COMMON.MODE' | translate }}</span></a>
                  </div>
                </div>
              </div>
             </div>
             <div class="dropdown-divider" appHideDividerIfPermissionsUnauthorized
              [permissionsAbove]="[permissionDisconnectorConnect,
                                    permissionDisconnectorDisconnect,
                                    permissionDisconnectorGetState,
                                    permissionDisconnectorSetMode,
                                    permissionCiiActivate,
                                    permissionCiiDeactivate,
                                    permissionCiiState,
                                    permissionRelaysConnect,
                                    permissionRelaysDisconnect,
                                    permissionRelaysState,
                                    permissionRelaysSetMode]"
              [permissionsBelow]="[permissionTouUpload]"></div>
              <div appHideIfPermissionUnauthorized [permission]="permissionTouUpload">
                <a  href="javascript:void(0)" class="dropdown-item custom-hover-display"
                  (click)="onTou()"><span>{{ 'PLC-METER.TOU-UPLOAD' | translate }}</span></a>
              </div>
              <div class="dropdown-divider" appHideDividerIfPermissionsUnauthorized
                [permissionsAbove]="[permissionTouUpload]"
                [permissionsBelow]="[permissionSetLimiter,
                                    permissionSetMonitor,
                                    permissionClearFF,
                                    permissionSetDisplay,
                                    permissionClearAlarms]"></div>

              <div appHideIfPermissionUnauthorized [permission]="permissionSyncTime">
                <a href="javascript:void(0)" class="dropdown-item custom-hover-display"
                   (click)="onSyncTime()"><span>{{ 'COMMON.SYNCHRONIZE-TIME' | translate }}</span></a>
              </div>

              <div class="dropdown-item" appHideIfAllPermissionsUnauthorized [permissions]="[permissionSetLimiter]">
                <div class="dropdown-submenu">
                  <a dropdownToggle class="dropdown-toggle disabled" href="javascript:void(0)" data-toggle="dropdown"><span>{{ 'COMMON.LIMITER' | translate }}</span></a>
                  <div class="dropdown-menu">
                    <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionSetLimiter" (click)="onSetLimiter()">
                      <a href="javascript:void(0)"><span>{{ 'PLC-METER.SET-THRESHOLDS' | translate }}</span></a>
                    </div>
                    <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionReadMeter" (click)="onReadLimiterThreshold()">
                      <a href="javascript:void(0)"><span>{{ 'PLC-METER.READ-THRESHOLDS' | translate }}</span></a>
                    </div>
                  </div>
                </div>
              </div>

              <div class="dropdown-item" appHideIfAllPermissionsUnauthorized [permissions]="[permissionSetMonitor]">  <!-- TODO permissions -->
                <div class="dropdown-submenu">
                  <a dropdownToggle class="dropdown-toggle disabled" href="javascript:void(0)" data-toggle="dropdown"><span>{{ 'COMMON.MONITOR' | translate }}</span></a>
                  <div class="dropdown-menu">
                    <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionSetMonitor" (click)="onSetMonitor()">
                      <a href="javascript:void(0)"><span>{{ 'PLC-METER.SET-THRESHOLDS' | translate }}</span></a>
                    </div>
                    <div class="dropdown-item" appHideIfPermissionUnauthorized [permission]="permissionReadMeter" (click)="onReadMonitorThreshold()">
                      <a href="javascript:void(0)"><span>{{ 'PLC-METER.READ-THRESHOLDS' | translate }}</span></a>
                    </div>
                  </div>
                </div>
              </div>

              <div appHideIfPermissionUnauthorized [permission]="permissionClearFF">
                <a href="javascript:void(0)" class="dropdown-item custom-hover-display"
                  (click)="onClearFF()"><span>{{ 'PLC-METER.CLEAR-FF' | translate }}</span></a>
              </div>
              <div appHideIfPermissionUnauthorized [permission]="permissionSetDisplay">
                <a href="javascript:void(0)" class="dropdown-item custom-hover-display"
                  (click)="onSetDisplaySettings()"><span>{{ 'PLC-METER.SET-DISPLAY-SETTINGS-TITLE' | translate }}</span></a>
              </div>
              <div appHideIfPermissionUnauthorized [permission]="permissionClearAlarms">
                <a href="javascript:void(0)" class="dropdown-item custom-hover-display gray-line"
                  (click)="onClearAlarms()"><span>{{ 'PLC-METER.CLEAR-ALARMS' | translate }}</span></a>
              </div>

              <div>
                <a href="javascript:void(0)" class="dropdown-item custom-hover-display item-padding"
                   (click)="onReadMeter()"><span>{{ 'COMMON.READ-METER' | translate }}</span></a>
              </div>

            </div>
          </div>

          <div dropdown class="btn-group pl-2" appHideIfAllPermissionsUnauthorized [permissions]="[permissionSecurityActivateHls, permissionSecurityRekey, permissionSecurityChangePassword]">
            <button dropdownToggle class="btn btn-primary dropdown-toggle" type="button" id="securityDropDown" data-toggle="dropdown"><span>{{ 'PLC-METER.SECURITY.SECURITY' | translate }}</span></button>
            <div *dropdownMenu (click)="$event.stopPropagation();" class="dropdown-menu" style="min-width: 13rem">
              <div appHideIfPermissionUnauthorized [permission]="permissionSecurityActivateHls">
                <a (click)="onSecurityActivateHls()" class="dropdown-item custom-hover-display" href="javascript:void(0)"><span>{{ 'PLC-METER.SECURITY.ACTIVATE-HLS-TITLE' | translate }}</span></a>
              </div>
              <div class="dropdown-divider" appHideDividerIfPermissionsUnauthorized
                [permissionsAbove]="[permissionSecurityActivateHls]"
                [permissionsBelow]="[permissionSecurityRekey,
                                    permissionSecurityChangePassword]"></div>
              <div appHideIfPermissionUnauthorized [permission]="permissionSecurityRekey">
                <a (click)="onSecurityRekey()" class="dropdown-item custom-hover-display" href="javascript:void(0)"><span>{{ 'PLC-METER.SECURITY.REKEY' | translate }}</span></a>
              </div>
              <div appHideIfPermissionUnauthorized [permission]="permissionSecurityChangePassword">
                <a (click)="onSecurityChangePassword()" class="dropdown-item custom-hover-display" href="javascript:void(0)"><span>{{ 'PLC-METER.SECURITY.CHANGE-PASSWORD-TITLE' | translate }}</span></a>
              </div>
            </div>
          </div>

          <button *ngIf="false" type="button" class="btn btn-primary" [disabled]="true">
            <i class="far fa-tags"></i>
            <span>{{ 'COMMON.TAGS' | translate }}</span>
          </button>
          <button *ngIf="false" type="button" class="btn btn-primary" [disabled]="true">
            <i class="far fa-chart-bar" disabled></i>
            <span>{{ 'COMMON.DATA' | translate }}</span>
          </button>
        </div>
      </app-action-form>
    </div>
  </div>

  <!-- load warning icon -->
  <img [src]="'assets/images/icons/warning-icon.svg'" class="display-none" />

  <!-- ag-grid -->
  <div class="content-body-scroll">
    <div>
      <ag-grid-angular
        class="ag-theme-epoint custom-paging"
        style="width: 100%; height: calc(100% - 25px);"
        #agGrid

        [domLayout]=agGridSettings.domLayout
        [localeText]="localeText"

        [modules]="modules"
        [icons]="icons"
        [pagination]=agGridSettings.pagination

        [multiSortKey]=agGridSettings.multiSortKey
        [cacheOverflowSize]="agGridSettings.cacheOverflowSize"
        [maxConcurrentDatasourceRequests]="agGridSettings.maxConcurrentDatasourceRequests"
        [frameworkComponents]="frameworkComponents"
        [maxBlocksInCache]="1"
        [gridOptions]="gridOptions"
        [columnDefs]="columns"

        [suppressRowClickSelection]=agGridSettings.suppressRowClickSelection
        [rowSelection]=agGridSettings.rowSelection
        [sideBar]="sideBar"

        [overlayNoRowsTemplate]="overlayNoRowsTemplate"
        [overlayLoadingTemplate]="overlayLoadingTemplate"
        (selectionChanged)="onSelectionChanged()"
        (gridReady)="onGridReady($event)"
        (columnVisible)="onColumnVisible($event)"
        (paginationChanged)="onPaginationChange($event)"
        (rowSelected)="onRowSelect($event)"
        (firstDataRendered)="onFirstDataRendered($event)"
        (gridSizeChanged)="gridSizeChanged()"
        [paginationPageSize]="selectedPageSize.id"
        [cacheBlockSize]="selectedPageSize.id"
        [suppressColumnVirtualisation]="true"
        >
      </ag-grid-angular>
      <div class="ag-paging-panel-selection d-flex">
        <div class="p-2 ml-1" *ngIf="getSelectedCount() > 0">
          <div class="mr-3" *ngIf="!checkSelectedAll() && getSelectedCount() > 0">
            <small class="link text-secondary">{{getSelectedCount()}} <strong><span>{{ 'COMMON.ITEMS-SELECTED' | translate }}</span> &middot;
              <a class="text-primary" href="javascript:void(0);" (click)="selectAll()">
                <span>{{ 'GRID.SELECT-ALL' | translate }}</span>({{totalCount}})</a> &middot;
              <a class="text-primary" href="javascript:void(0);" (click)="deselectAll()">
                <span>{{ 'GRID.CLEAR-SELECTED' | translate }}</span></a>
                  </strong></small>
          </div>

          <div class="mr-3" *ngIf="checkSelectedAll()">
            <small class="link text-secondary"><strong><span>{{ 'COMMON.ALL' | translate }}</span> ({{getTotalCountWithoutExcludedDisplay()}}) <span>{{ 'COMMON.ITEMS-SELECTED' | translate }}</span> &middot;
              <a class="text-primary" href="javascript:void(0);" (click)="deselectAll()">
                <span>{{ 'GRID.CLEAR-SELECTED' | translate }}</span></a></strong></small>
          </div>
        </div>
        <div class="ml-auto">
          <app-select-dropdown [form]="form" [property]="pageSizeProperty" [selectOptions]="pageSizes"
            [disabled]="false" (selectedValueChanged)="pageSizeChanged($event)">
          </app-select-dropdown>
        </div>
      </div>
    </div>
    <div *ngIf="noData" class="d-flex flex-column justify-content-center align-items-center" style="height:80vh;">
      <div class="p-1"><i class="far fa-empty-set fa-3x text-secondary"></i></div>
      <div class="p-1"><h2>{{ 'DCU.NO-DATA-CONCENTRATOR-UNITS' | translate }}</h2></div>
      <div class="p-1"><button type="button" class="btn btn-primary bg-primary" ><i class="far fa-plus">
        <span>{{ 'COMMON.ADD-NEW' | translate }}</span></i>
      </button></div>
    </div>
    </div>
</div>
</div>
<ng-template #tipMoreSave><span>{{ 'COMMON.MORE-OPTIONS' | translate }}</span></ng-template>
<ng-template #hidwShowFilters><span>{{ 'GRID.SHOW-HIDE-FILTERS' | translate }}</span></ng-template>
